# Three-step pipeline to predict survival response in anti-PD1 lugn cancer patients

Pred1ctors team code for [Anti-PD1 DREAM Challenge](https://www.synapse.org/#!Synapse:syn18404605/wiki/607226)

## Methods

### Train data download
Data from Gide2019, GSE52562, GSE67501, GSE78220, GSE115821, GSE100797, Prat2017, Riaz2017 and TCGA cohorts (SKCM, LUAD and LUSC)  was downloaded to create the train dataset. Only pre-treatment samples were selected in each cohort. Clinical covariates (patID, cohort, tumor.type, treatment, OS, OS.Event, PFS, PFS.Event, Response, RECIST, Age, Gender, Smoking, stage and TMB) were selected when available. In addition, counts expression data also was retrieved.

### Train data pre-processing
The counts data for each cohort was converted into Gene Symbol notation. Genes were intersected between all cohorts and synthetic data file GRCh37ERCC_refseq105_genes_count. In addition, each cohort was log2 transformed and scaled, when necessary. After cohorts merging, genes without Not Available (NA) values were included in the training phase. Finally, 568 genes were selected.
Samples were filtered according to tumor type and drug features. Melanoma, anti-PD1 and Chemo samples were selected, including a total of 946 samples. Due to lack of samples, not only Nivolumab treatment was included in anti-PD1 samples. Patients who were treated with pidilizumab, nivolumab and pembrolizumab were included in this group. To avoid batch effects among different cohorts, we carried out the ComBat function from the sva R package. Two different datasets were created according to the PFS and OS data available from the samples. The times and events in both PFS and OS datasets were restricted to five years.
Both datasets were pre-processed in the same manner. First, a principal component analysis (PCA) was performed on the metacohort count data. PCA calculations were calculated from the PCAtools R package. We selected 15 PCA´s according to their elbow score. Clinical covariates Cohort, Age, Drug, PFS and PFS.Event were added to PCA´s variables. All clinical variables were numeric transformed before the training phase. To perform the analysis, only stage IV samples were selected.

### Training phase
The training phase was realized by using three different modules (transcription module, tumor type module and TMB module):
The transcription module was generated by the biospear package in R 9. The biospear package allows selecting the biomarkers with the strongest impact on survival and on the treatment effect in high-dimensional Cox models and estimating expected survival probabilities. Biospear includes a large variety of models based on penalized regression techniques.
The following models were included in the experiment: alassoR, alassoU, enet, lasso, lasso-1se, lasso-AIC, lasso-BIC, lasso-HQIC, lasso-pct, lasso-pcvl, lasso-RIC, PCAlasso, PLSlasso, ridgelasso, uniFDR. We selected a binary variable Drug (anti-PD1 vs Chemo) as treatment variable. Biomarkers variables were the first 15 PCA´s in the PFS model, and the first 14 PCA´s in the OS model with Cohort and Age as clinical covariates. In both models, ridgelasso was chosen as the model.
The tumor type module consisted of a Cox Proportional Hazard Model (CPH). For this module, a CPH was built according to three clinical covariates: age, tumor type and gender. This module was used in both PFS and OS models. First, we filtered patients in accordance with tumor type, to select samples of non-squamous and squamous lung cancer.
The Tumor Mutation Burden (TMB) module also consisted of a CPH model. For the PFS model we selected melanoma samples in stage IV. The CPH model was built with age, gender, drug and TMB variables. Gender variable was removed in the OS model. In both models, the TMB variable was converted into binary. Samples with values higher than 242 were labelled as high. TMB variable was included in the Cox model with interaction with the variable drug (anti-PD1 vs Chemo).

### Validation phase
Counts (GRCh37ERCC_refseq105_genes_count) clinical files were loaded. First, we matched the XXX genes with which the PCA´s were calculated on the training data. Then, log2 transformation and scaling were carried out. To avoid problems with NA values, we impute possible missing values through the impute.knn function from the impute R package. This function finds the k-nearest neighbors using a Euclidean metric, confined to the columns for which each gene is not missing. To avoid batch effects, we carried out the ComBat function. In this case, the train data is established as the reference batch.
After the ComBat function the PCA´s are predicted and we added clinical data (Drug, Cohort and Age) to predict in the transcription module. Since we do not have the variables Drug and Cohort, all samples are labelled as 1.5 and 0 respectively. Note that drug=0 denotes that it has been treated with anti-PD1.
For the tumor type module, we retrieve the following clinical covariates: age, tumor type, drug, and gender. For the TMB module the age, TMB, drug and gender were selected. TMB variable was converted into binary like in the training phase.
Finally, the three predictions were summed to obtain the final prediction of each sample.


## Discussion
We have developed a three-step survival model to predict survival events in different treatment groups of patients. The major novelty is the way to include three steps with drug interaction information. We observe a lot of difference in our external validation in comparison with validation data of the challenge. The main obstacle was the great heterogeneity of the data available to us. Our strategy to split the prediction in 3 modules, in order to maximize the training sample size of the available cohorts didn't work as expected. We think that the interaction framework with the expression and TMB is a relevant approach, however more data with RNA-seq and TMB in lung would be necessary to improve the accuracy of our predictors.


## Future work
Unfortunately, our model did not achieve the desired level of performance for this challenge. However, we see this as an opportunity to learn and improve. The challenges encountered during the development process have provided valuable insights that could guide future iterations and enhancements. We plan to continue refining our model and exploring alternative strategies to improve its performance. Additionally, we welcome collaboration and feedback from the community to enhance the effectiveness of our approach and contribute to the broader goals of this research field.

